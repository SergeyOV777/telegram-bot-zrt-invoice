#cloud-config
package_update: true
package_upgrade: true

packages:
  - python3
  - python3-pip
  - python3-venv
  - git
  - curl
  - wget
  - ufw
  - htop
  - nano
  - tree

users:
  - name: botuser
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCz6l7Vtb14YGfsf+ssh1VDyHsVtemcCfP4J8obVJY7Abmnn0pQje7C3JIIF8LEMTUNXMaLJDFqTA4XCjKS+d+hq443zyKUiQ2YYEgpQvUzFcAXjOXZQw+kI7Tvdpujk69SoubZMOccepDSWofDz54Koddvci8HS0EbpieJKjJ4fKOhxuOLOE0w7c5hEF6X9cdEH1GrGux47eTvfyym6oUKz8JibTQA5rHN9CDoM75CSvIcBDONotl8hmG1OrCw7ECuh72CBg5/xBl5IsmAifPbgVEroFoYK6qqhmFfJU2mqeQfcSXb5T1oYdzAujp955k/sMC1TWIekFLkXFcbdpWF sergeyobraztsovk@gmail.com

write_files:
  - path: /root/telegram_invoice_bot/requirements.txt
    content: |
      python-telegram-bot==13.15
      google-api-python-client==2.56.0
      google-auth-httplib2==0.1.0
      google-auth-oauthlib==1.0.0
      python-dotenv==1.0.0
      requests==2.31.0

  - path: /root/telegram_invoice_bot/bot.service
    content: |
      [Unit]
      Description=Telegram Invoice Bot
      After=network.target

      [Service]
      Type=simple
      User=root
      WorkingDirectory=/root/telegram_invoice_bot
      Environment=PATH=/root/telegram_invoice_bot/venv/bin
      ExecStart=/root/telegram_invoice_bot/venv/bin/python /root/telegram_invoice_bot/main.py
      Restart=always
      RestartSec=10
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target

  - path: /root/telegram_invoice_bot/monitor.service
    content: |
      [Unit]
      Description=Telegram Bot Monitor
      After=network.target bot.service

      [Service]
      Type=simple
      User=root
      WorkingDirectory=/root/telegram_invoice_bot
      Environment=PATH=/root/telegram_invoice_bot/venv/bin
      Environment=BOT_TOKEN=your_bot_token_here
      ExecStart=/root/telegram_invoice_bot/venv/bin/python /root/telegram_invoice_bot/monitoring.py
      Restart=always
      RestartSec=30
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target

  - path: /root/telegram_invoice_bot/manage.sh
    content: |
      #!/bin/bash
      BOT_NAME="bot"
      case "$1" in
          start)
              echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°..."
              systemctl start $BOT_NAME
              systemctl status $BOT_NAME
              ;;
          stop)
              echo "â¹ï¸ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°..."
              systemctl stop $BOT_NAME
              ;;
          restart)
              echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°..."
              systemctl restart $BOT_NAME
              systemctl status $BOT_NAME
              ;;
          status)
              echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð±Ð¾Ñ‚Ð°:"
              systemctl status $BOT_NAME
              ;;
          logs)
              echo "ðŸ“ Ð›Ð¾Ð³Ð¸ Ð±Ð¾Ñ‚Ð° (Ctrl+C Ð´Ð»Ñ Ð²Ñ‹Ñ…Ð¾Ð´Ð°):"
              journalctl -u $BOT_NAME -f
              ;;
          logs-all)
              echo "ðŸ“ Ð’ÑÐµ Ð»Ð¾Ð³Ð¸ Ð±Ð¾Ñ‚Ð°:"
              journalctl -u $BOT_NAME
              ;;
          enable)
              echo "âœ… Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°..."
              systemctl enable $BOT_NAME
              ;;
          disable)
              echo "âŒ ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°..."
              systemctl disable $BOT_NAME
              ;;
          update)
              echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð±Ð¾Ñ‚Ð°..."
              cd /root/telegram_invoice_bot
              git pull
              source venv/bin/activate
              pip install -r requirements.txt
              systemctl restart $BOT_NAME
              echo "âœ… ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
              ;;
          *)
              echo "ðŸ“‹ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: $0 {start|stop|restart|status|logs|logs-all|enable|disable|update}"
              exit 1
              ;;
      esac

  - path: /root/telegram_invoice_bot/setup.sh
    content: |
      #!/bin/bash
      echo "ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Telegram Ð±Ð¾Ñ‚Ð°..."
      
      # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
      mkdir -p /root/telegram_invoice_bot
      cd /root/telegram_invoice_bot
      
      # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
      echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ..."
      python3 -m venv venv
      source venv/bin/activate
      
      # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      echo "ðŸ“š Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
      pip install --upgrade pip
      pip install -r requirements.txt
      
      # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»
      echo "âš™ï¸ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»..."
      cat > .env << EOF
      # Telegram Bot Token
      BOT_TOKEN=your_bot_token_here
      
      # Google Sheets API
      GOOGLE_CREDENTIALS=your_google_credentials_here
      SPREADSHEET_ID=your_spreadsheet_id_here
      SHEET_NAME=your_sheet_name_here
      SERVICE_ACCOUNT_FILE=service_account.json
      EOF
      
      # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ systemd ÑÐ»ÑƒÐ¶Ð±Ñ‹
      echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ systemd ÑÐ»ÑƒÐ¶Ð±Ñ‹..."
      cp bot.service /etc/systemd/system/
      cp monitor.service /etc/systemd/system/
      systemctl daemon-reload
      
      # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð°
      chmod +x manage.sh
      chmod +x setup.sh
      
      echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
      echo "ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
      echo "1. ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» .env: nano /root/telegram_invoice_bot/.env"
      echo "2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð±Ð¾Ñ‚Ð°: ./manage.sh start"
      echo "3. Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº: ./manage.sh enable"

runcmd:
  # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° firewall
  - ufw allow ssh
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable
  
  # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°
  - mkdir -p /root/telegram_invoice_bot
  - cd /root/telegram_invoice_bot
  - chmod +x setup.sh
  - ./setup.sh
  
  # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
  - echo "*/5 * * * * /root/telegram_invoice_bot/venv/bin/python /root/telegram_invoice_bot/monitoring.py" | crontab -
  
  # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð»Ð¾Ð³ Ñ„Ð°Ð¹Ð»Ð¾Ð²
  - touch /var/log/bot.log
  - touch /var/log/bot_monitor.log
  - chmod 644 /var/log/bot.log
  - chmod 644 /var/log/bot_monitor.log
  
  # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
  - echo "ðŸŽ‰ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½! Telegram Ð±Ð¾Ñ‚ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ."
  - echo "ðŸ“ ÐÐµ Ð·Ð°Ð±ÑƒÐ´ÑŒÑ‚Ðµ Ð¾Ñ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» .env Ñ Ð²Ð°ÑˆÐ¸Ð¼Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð°Ð¼Ð¸!" 