#cloud-config
package_update: true
package_upgrade: true

packages:
  - python3
  - python3-pip
  - python3-venv
  - git
  - curl
  - wget
  - ufw
  - nano

users:
  - name: botuser
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCz6l7Vtb14YGfsf+ssh1VDyHsVtemcCfP4J8obVJY7Abmnn0pQje7C3JIIF8LEMTUNXMaLJDFqTA4XCjKS+d+hq443zyKUiQ2YYEgpQvUzFcAXjOXZQw+kI7Tvdpujk69SoubZMOccepDSWofDz54Koddvci8HS0EbpieJKjJ4fKOhxuOLOE0w7c5hEF6X9cdEH1GrGux47eTvfyym6oUKz8JibTQA5rHN9CDoM75CSvIcBDONotl8hmG1OrCw7ECuh72CBg5/xBl5IsmAifPbgVEroFoYK6qqhmFfJU2mqeQfcSXb5T1oYdzAujp955k/sMC1TWIekFLkXFcbdpWF sergeyobraztsovk@gmail.com

write_files:
  - path: /root/setup_bot.sh
    content: |
      #!/bin/bash
      echo "ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Telegram Ð±Ð¾Ñ‚Ð°..."
      
      # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
      apt update && apt upgrade -y
      
      # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      apt install -y python3 python3-pip python3-venv git curl wget ufw nano
      
      # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð°
      mkdir -p /root/telegram_invoice_bot
      cd /root/telegram_invoice_bot
      
      # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
      python3 -m venv venv
      source venv/bin/activate
      
      # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ requirements.txt
      cat > requirements.txt << EOF
      python-telegram-bot==13.15
      google-api-python-client==2.56.0
      google-auth-httplib2==0.1.0
      google-auth-oauthlib==1.0.0
      python-dotenv==1.0.0
      requests==2.31.0
      EOF
      
      # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      pip install --upgrade pip
      pip install -r requirements.txt
      
      # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»
      cat > .env << EOF
      # Telegram Bot Token
      BOT_TOKEN=your_bot_token_here
      
      # Google Sheets API
      GOOGLE_CREDENTIALS=your_google_credentials_here
      SPREADSHEET_ID=your_spreadsheet_id_here
      SHEET_NAME=your_sheet_name_here
      SERVICE_ACCOUNT_FILE=service_account.json
      EOF
      
      # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐ»ÑƒÐ¶Ð±Ñƒ
      cat > /etc/systemd/system/bot.service << EOF
      [Unit]
      Description=Telegram Invoice Bot
      After=network.target

      [Service]
      Type=simple
      User=root
      WorkingDirectory=/root/telegram_invoice_bot
      Environment=PATH=/root/telegram_invoice_bot/venv/bin
      ExecStart=/root/telegram_invoice_bot/venv/bin/python /root/telegram_invoice_bot/main.py
      Restart=always
      RestartSec=10
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target
      EOF
      
      # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ systemd
      systemctl daemon-reload
      
      # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ firewall
      ufw allow ssh
      ufw allow 80/tcp
      ufw allow 443/tcp
      ufw --force enable
      
      echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
      echo "ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
      echo "1. Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð±Ð¾Ñ‚Ð° Ð² /root/telegram_invoice_bot/"
      echo "2. ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» .env: nano /root/telegram_invoice_bot/.env"
      echo "3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð±Ð¾Ñ‚Ð°: systemctl start bot"
      echo "4. Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº: systemctl enable bot"

runcmd:
  - chmod +x /root/setup_bot.sh
  - /root/setup_bot.sh
  - echo "ðŸŽ‰ Cloud-init Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½! Ð¡ÐµÑ€Ð²ÐµÑ€ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ Ñ Telegram Ð±Ð¾Ñ‚Ð¾Ð¼." 